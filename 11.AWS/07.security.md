# 7. セキュリティとアイデンティティ
## 7.1. セキュリティとアイデンティティ
### AWSのアカウント管理
- AWSには**AWSアカウント**と**IAMユーザ**と呼ばれる2種類のアカウントが存在する
- AWSアカウントはAWSへサインアップ時に作成されるアカウントで、AWSの全てのサービスを利用可能なためルートユーザとも呼ばれる
- IAMユーザはAWSを利用する各利用者向けに作成されるアカウント

### AWSアカウント
- 非常に強力な権限を持っているので取り扱い注意
- 基本的にAWSでシステムを構築/運用する際はAWSアカウントは使用しない

### IAMユーザ
- IAMユーザは各利用者がWebコンソールにログインして操作をする際やAPIを介して操作する際に使用する
- 各IAMユーザに対して操作を許可するサービス等を定義できる
  - e.g. EC2インスタンスのstartとstopの権限は付与するが、terminate権限は付与しない

### IAMの機能
- 主要な機能は下記の4つ

|機能|
|---|
|IAMポリシー|
|IAMユーザ|
|IAMグループ|
|IAMロール|

- 上記の機能を用いて権限を付与する流れは下記
  - AWSサービスやAWSリソースに対する操作権限を**IAMポリシー**として定義する
  - IAMポリシーを**IAMユーザ**や**IAMグループ**にアタッチする

### IAMポリシー
- **IAMポリシー**とは、ユーザやグループ、ロールに付与する権限を管理するオブジェクト
- IAMポリシーは**Action**(どのサービスの)、**Resource**(どのような機能や範囲を)、**Effect**(許可/拒否)という大きな3つのルールに基づいて、権限を設定する
- 作成されたポリシーをIAMユーザやIAMロールにアタッチすることで権限の制御を行う

#### インラインポリシーと管理ポリシー
- ポリシーには**インラインポリシー**と**管理ポリシー**が存在する
- インラインポリシーは対象ごとに作成・付与されるポリシーで、複数のユーザー/グループに同種の権限を付与するには不向き
- 管理ポリシーは、1つのポリシーを複数のユーザやグループにアタッチすることができる
- 管理ポリシーはさらに**AWS管理ポリシー**と**カスタマー管理ポリシー**に分けられる
  - AWS管理ポリシーはAWSによって用意されているポリシー
  - カスタマー管理ポリシーはユーザ自身が設定できるポリシー
    - 最大過去5世代までバージョン管理をすることができる
  - 一般的には、AWS管理ポリシーで基本的な権限を付与して、カスタマー管理ポリシーでIPアドレス制限を行う等の使い分けがされる
<!-- 図 -->

### IAMユーザとIAMグループ
- ユーザとは各利用者に1つずつ付与される認証情報
  - ユーザIDとパスワード：Webコンソールにログインする際に使用する
  - アクセスキーとシークレットアクセスキー：CLIやAPIからAWSにアクセスする際に使用する
- グループは同じ権限を持ったユーザの集まりで、AWSへのアクセス認証情報は保持しない(認証はユーザで行う)
  - グループはユーザがどのような権限を持つかを管理し、権限管理を容易、正確に行うことを目的とする
  - ユーザとグループはn対nの関係を持つことができる(1ユーザが複数グループに属することや、1グループに複数ユーザが属することもできる)が、階層化はできない

### IAMロール
- IAMロールは一時的なAWSリソースの操作権限を付与する
- IAMロールによって例えば下記が可能となる
  - クロスアカウントアクセス
    - 複数のAWSアカウント間のリソースを1つのIAMユーザで操作する
  - IDフェデレーション
    - 社内のAD(Active Directory)サーバに登録されているアカウントを利用してAWSにアクセスする
  - Web IDフェデレーション
    - Google等のアカウントを使用してAWSリソースにアクセスする

## 7.2. KMSとCloudHSM
### KMSとCloudHSM
- AWSには鍵管理サービスとして**KMS**(Key Management System)と**CloudHSM**がある

||CloudHSM|KMS|
|---|---|---|
|専有性|VPC内の専有HW|AWSが管理するマルチテナント|
|可用性|ユーザが管理|AWS側が高可用性/耐久性を設計|
|信頼の基点|ユーザが管理|AWS側が管理|
|暗号化機能|共通鍵および公開鍵|共通鍵|
|コスト|ほぼ固定費|従量課金|

- CloudHSMは専有ハードウェアを用いるため初期コストと固定費が必要
  - よほど大規模なシステムや特定の規制/法令に準拠する目的以外ではあまり利用されないが、秒間100以上の暗号化リクエストを受ける場合や公開鍵暗号化を使用した場合はCloudHSMを利用する

### KMSの機能
- 主な機能は鍵管理機能とデータ暗号化機能の2つ
- データ暗号化機能としては下記の3つのAPIがある

|API|概要|
|---|---|
|Encrypt|4KBまでの平文の暗号化を行う|
|Decrypt|復号化を行う|
|GenerateDataKey|データの暗号化に利用のためのカスタマーデータキーを生成する<br>平文の鍵とEncrypt APIで暗号化された鍵を返す|

### マスターキーとデータキー
- KMSでは主に**マスターキー**と**データキー**(AWSでは**CMK(Customer Master Key)**と**CDK(Customer Data Key)**と呼ばれる)を管理する
- CMKはデータキーを暗号化するための鍵で、CDKはデータを暗号化するための鍵
- KMSではデータの暗号化の際に**データキーでデータを暗号化してから、そのデータキーをマスターキーで暗号化する**手法(**エンベロープ暗号化**)をとっている
  - 実際の運用で使う頻度の多いデータキーを暗号化で保護し、マスターキーを集中管理することによってセキュリティを高めている

### クライアントサイド暗号化とサーバーサイド暗号化
- 暗号化はどこで(クライアント/サーバー)暗号化するのかも重要となる
- **クライアントサイド暗号化**はユーザ側の処理で暗号化する方式で、EC2やLambda内のプログラムで暗号化してS3にアップするケースもこれに該当する
  - 経路の安全性が保障できない場合はクライアントサイドで暗号化する
- **サーバサイド暗号化**はAWS側でさん暗号化を行うこと

## 7.3. AWS Certificate Manager
### 証明書の役割と種類
- 証明書を利用することで、**経路間の通信の安全性の確保**と**通信している相手が誰かの証明**をすることができる
- 証明には下記の4種類が存在する

|種類|概要|
|---|---|
|自己証明書|自分で認証局を立てて証明書を発行する|
|ドメイン認証(DV)|ドメインの所有のみを認証<br>組織情報の確認はされない|
|組織認証(OV)|組織情報の審査を経てから認証する|
|拡張認証(EV)|OVより厳格な審査で認証する<br>アドレスバーに組織名が表示される|

### ACM
- **AWS Certificate Manager**の略で、AWSが認証局となってDV証明書を発行するサービス
- ACMの証明書の有効期限は13ヶ月で、自動更新の設定も可能
- ACMを利用できるのはAWSサービスのみで、無料で利用可能
  - 2019/3現在で利用可能なサービスはELB, CloudFront, Elastic Beanstalk, API Gatewayの4つ